---

- name: Check homeassistant config
  become: yes
  become_user: '{{ home_assistant_user }}'
  command: '/home/{{ home_assistant_user }}/{{ home_assistant_dir }}/bin/hass --script check_config'
  register: hass_config_check
  notify: Assert config

- name: Assert config
  assert:
    that:
      - "'ERROR' not in hass_config_check.stdout"
    msg: "Config check reported error"

- name: Restart homeassistant
  become: yes
  service:
    name: home-assistant
    state: restarted
  when: skip_hass_restart is not defined
  register: hass_is_restarting

- name: Reload group config
  uri:
    url: "{{ hass_url }}/api/services/group/reload"
    method: POST
    headers:
      x-ha-access: "{{ hass_password }}"
      Content-Type: application/json
  when: hass_is_restarting is not defined

- name: Reload automation config
  uri:
    url: "{{ hass_url }}/api/services/automation/reload"
    method: POST
    headers:
      x-ha-access: "{{ hass_password }}"
      Content-Type: application/json
  when: hass_is_restarting is not defined

- name: Reload core config
  uri:
    url: "{{ hass_url }}/api/services/homeassistant/reload_core_config"
    method: POST
    headers:
      x-ha-access: "{{ hass_password }}"
      Content-Type: application/json
  when: hass_is_restarting is not defined

- name: Reload script config
  uri:
    url: "{{ hass_url }}/api/services/script/reload"
    method: POST
    headers:
      x-ha-access: "{{ hass_password }}"
      Content-Type: application/json
  when: hass_is_restarting is not defined
